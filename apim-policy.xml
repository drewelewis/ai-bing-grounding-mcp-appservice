<!--
    Azure API Management Policy for Multi-Region Load Balancing with Geo-Routing
    
    Features:
    - Geo-aware routing (route to nearest region based on client location)
    - Cookie-based session affinity (sticky sessions per region)
    - Automatic circuit breaking based on backend health
    - Failover to healthy region when backend returns 500, 429, or 401
    - Automatic recovery when backends return 200 OK
    
    Regions:
    - eastus: East US App Service
    - westeurope: West Europe App Service
    
    Apply this policy at the API level for your main endpoints
-->
<policies>
    <inbound>
        <base />
        
        <!-- Define backend regions with metadata -->
        <set-variable name="backendConfig" value="@{
            return new System.Collections.Generic.Dictionary<string, object>[] {
                new System.Collections.Generic.Dictionary<string, object> {
                    { "id", "eastus" },
                    { "url", "https://{{EASTUS_WEBAPP_HOSTNAME}}" },
                    { "region", "eastus" },
                    { "continent", "NA" }
                },
                new System.Collections.Generic.Dictionary<string, object> {
                    { "id", "westeurope" },
                    { "url", "https://{{WESTEUROPE_WEBAPP_HOSTNAME}}" },
                    { "region", "westeurope" },
                    { "continent", "EU" }
                }
            };
        }" />
        
        <!-- Check for healthy backends from cache -->
        <set-variable name="healthyBackends" value="@{
            var allBackends = new[] { "eastus", "westeurope" };
            var healthyList = new System.Collections.Generic.List<string>();
            
            foreach (var id in allBackends)
            {
                string cacheKey = "backend-health-" + id;
                string healthStatus;
                
                if (context.Cache.TryGetValue(cacheKey, out healthStatus))
                {
                    if (healthStatus == "healthy")
                    {
                        healthyList.Add(id);
                    }
                }
                else
                {
                    // Default to healthy if no cache entry
                    healthyList.Add(id);
                }
            }
            
            return healthyList.Count > 0 ? healthyList.ToArray() : allBackends;
        }" />
        
        <!-- Determine preferred region based on client geo-location -->
        <set-variable name="preferredRegion" value="@{
            // Get client IP geo info from APIM context
            var clientRegion = context.Request.Headers.GetValueOrDefault("X-Azure-ClientRegion", "");
            var forwardedFor = context.Request.Headers.GetValueOrDefault("X-Forwarded-For", "");
            
            // Map Azure regions to preferred backend
            // European clients -> westeurope, Americas/Others -> eastus
            var europeanPrefixes = new[] { "EU", "europe", "uk", "de", "fr", "nl", "be", "it", "es", "pl", "se", "no", "dk", "fi", "at", "ch" };
            
            foreach (var prefix in europeanPrefixes)
            {
                if (clientRegion.ToLower().Contains(prefix.ToLower()))
                {
                    return "westeurope";
                }
            }
            
            // Default to East US for Americas and unknown regions
            return "eastus";
        }" />
        
        <!-- Session affinity with health check and geo-routing -->
        <choose>
            <!-- Check for existing session cookie -->
            <when condition="@(context.Request.Headers.GetValueOrDefault("Cookie","").Contains("APIM-Backend-Region"))">
                <set-variable name="backendInstance" value="@{
                    string cookie = context.Request.Headers.GetValueOrDefault("Cookie","");
                    var match = System.Text.RegularExpressions.Regex.Match(cookie, @"APIM-Backend-Region=([a-z]+)");
                    string requestedRegion = match.Success ? match.Groups[1].Value : null;
                    var healthyBackends = (string[])context.Variables["healthyBackends"];
                    
                    // Use session region if healthy
                    if (requestedRegion != null && healthyBackends.Contains(requestedRegion))
                    {
                        return requestedRegion;
                    }
                    
                    // Fallback to preferred region based on geo
                    string preferred = (string)context.Variables["preferredRegion"];
                    if (healthyBackends.Contains(preferred))
                    {
                        return preferred;
                    }
                    
                    // Last resort: any healthy backend
                    return healthyBackends[0];
                }" />
            </when>
            <otherwise>
                <!-- No session: use geo-routing with health check -->
                <set-variable name="backendInstance" value="@{
                    var healthyBackends = (string[])context.Variables["healthyBackends"];
                    string preferred = (string)context.Variables["preferredRegion"];
                    
                    // Use preferred region if healthy
                    if (healthyBackends.Contains(preferred))
                    {
                        return preferred;
                    }
                    
                    // Fallback to any healthy backend
                    return healthyBackends[0];
                }" />
            </otherwise>
        </choose>
        
        <!-- Set backend URL based on region -->
        <set-backend-service base-url="@{
            string region = context.Variables.GetValueOrDefault<string>("backendInstance", "eastus");
            var backends = new System.Collections.Generic.Dictionary<string, string> {
                { "eastus", "https://{{EASTUS_WEBAPP_HOSTNAME}}" },
                { "westeurope", "https://{{WESTEUROPE_WEBAPP_HOSTNAME}}" }
            };
            return backends.ContainsKey(region) ? backends[region] : backends["eastus"];
        }" />
        
        <set-header name="X-APIM-Correlation-Id" exists-action="skip">
            <value>@(Guid.NewGuid().ToString())</value>
        </set-header>
        
        <set-header name="X-Backend-Region" exists-action="override">
            <value>@(context.Variables.GetValueOrDefault<string>("backendInstance", "eastus"))</value>
        </set-header>
        
        <set-header name="X-Client-Preferred-Region" exists-action="override">
            <value>@(context.Variables.GetValueOrDefault<string>("preferredRegion", "unknown"))</value>
        </set-header>
    </inbound>
    
    <backend>
        <base />
    </backend>
    
    <outbound>
        <base />
        
        <!-- Circuit breaker: Update health status based on response -->
        <choose>
            <when condition="@(context.Response.StatusCode >= 500 || context.Response.StatusCode == 429 || context.Response.StatusCode == 401)">
                <!-- Mark backend as unhealthy for 30 seconds on errors -->
                <cache-store-value key="@("backend-health-" + context.Variables.GetValueOrDefault<string>("backendInstance"))" value="unhealthy" duration="30" />
            </when>
            <when condition="@(context.Response.StatusCode == 200)">
                <!-- Mark backend as healthy on 200 OK response -->
                <cache-store-value key="@("backend-health-" + context.Variables.GetValueOrDefault<string>("backendInstance"))" value="healthy" duration="30" />
            </when>
        </choose>
        
        <!-- Set session affinity cookie with region -->
        <set-header name="Set-Cookie" exists-action="append">
            <value>@{
                string region = context.Variables.GetValueOrDefault<string>("backendInstance", "eastus");
                return $"APIM-Backend-Region={region}; Path=/; Max-Age=86400; HttpOnly; Secure; SameSite=Lax";
            }</value>
        </set-header>
        
        <set-header name="X-Served-By-Region" exists-action="override">
            <value>@(context.Variables.GetValueOrDefault<string>("backendInstance", "eastus"))</value>
        </set-header>
    </outbound>
    
    <on-error>
        <base />
        
        <!-- Circuit breaker: Mark backend as unhealthy on connection errors -->
        <cache-store-value key="@("backend-health-" + context.Variables.GetValueOrDefault<string>("backendInstance", "eastus"))" value="unhealthy" duration="30" />
        
        <set-header name="X-Error-Backend-Region" exists-action="override">
            <value>@(context.Variables.GetValueOrDefault<string>("backendInstance", "unknown"))</value>
        </set-header>
    </on-error>
</policies>
