# Deploy Infrastructure with Azure Developer CLI (azd)
#
# This workflow provisions Azure infrastructure using azd and Bicep templates.
# Supports multi-region deployments with AI Foundry, App Service, and APIM.
#
# PREREQUISITES - AUTOMATED SETUP:
#   Run: python setup/setup_azure_auth.py
#
#   This script will:
#   1. Create Azure Service Principal
#   2. Add Federated Credentials for your chosen environment:
#      - {environment}_primary
#      - {environment}_secondary
#   3. Configure GitHub secrets and environment variables
#
# Required secrets (set by setup script):
#   AZURE_CLIENT_ID       - Service principal app ID (for OIDC)
#   AZURE_TENANT_ID       - Azure AD tenant ID
#   AZURE_SUBSCRIPTION_ID - Azure subscription ID
#
# Required variables (per environment, set by setup script):
#   AZURE_ENV_NAME             - azd environment name (e.g., "prod", "qa", "development")
#   AZURE_LOCATION_PRIMARY     - Primary region (e.g., "eastus2")
#
# Optional variables:
#   AZURE_LOCATION_SECONDARY - Secondary region (e.g., "westus2")

name: Deploy Infrastructure

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - provision      # Provision infrastructure only
          - deploy         # Deploy app only (after provision)
          - up             # Full provision + deploy
          - down           # Tear down infrastructure
          - what-if        # Preview changes without applying
      
      environment:
        description: 'Target environment (e.g., prod, qa, development)'
        required: true
        type: string
        default: 'prod'
      
      skip_hooks:
        description: 'Skip pre/post provision hooks'
        required: false
        type: boolean
        default: false

# Required for OIDC authentication with Azure
permissions:
  id-token: write
  contents: read

env:
  PYTHON_VERSION: '3.11'
  AZD_VERSION: 'latest'

jobs:
  validate:
    name: Validate Inputs
    runs-on: ubuntu-latest
    outputs:
      environment_name: ${{ steps.set-env.outputs.environment_name }}
    
    steps:
      - name: Set environment name
        id: set-env
        run: |
          # Use input environment or fall back to variable
          ENV_NAME="${{ github.event.inputs.environment }}"
          if [ -z "$ENV_NAME" ]; then
            ENV_NAME="${{ vars.AZURE_ENV_NAME }}"
          fi
          echo "environment_name=$ENV_NAME" >> $GITHUB_OUTPUT
          echo "ðŸ“ Environment: $ENV_NAME"

  what-if:
    name: Preview Changes (What-If)
    needs: validate
    runs-on: ubuntu-latest
    if: github.event.inputs.action == 'what-if'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install azd
        run: curl -fsSL https://aka.ms/install-azd.sh | bash

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Configure azd environment
        run: |
          azd config set auth.useAzCliAuth true
          azd env new ${{ needs.validate.outputs.environment_name }} --no-prompt || true
          azd env select ${{ needs.validate.outputs.environment_name }}
          
          # Set location
          azd env set AZURE_LOCATION "${{ vars.AZURE_LOCATION_PRIMARY }}"
          
          # Set secondary location if configured
          if [ -n "${{ vars.AZURE_LOCATION_SECONDARY }}" ]; then
            azd env set AZURE_LOCATION_SECONDARY "${{ vars.AZURE_LOCATION_SECONDARY }}"
          fi

      - name: Preview infrastructure changes
        run: |
          echo "## Infrastructure Preview (What-If)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Run Bicep what-if
          az deployment sub what-if \
            --location "${{ vars.AZURE_LOCATION_PRIMARY }}" \
            --template-file infra/main.bicep \
            --parameters infra/main.parameters.json \
            --parameters environmentName=${{ needs.validate.outputs.environment_name }} \
            >> $GITHUB_STEP_SUMMARY 2>&1 || true

  provision:
    name: Provision Infrastructure
    needs: validate
    runs-on: ubuntu-latest
    if: github.event.inputs.action == 'provision' || github.event.inputs.action == 'up'
    environment:
      name: ${{ needs.validate.outputs.environment_name }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Python dependencies
        run: pip install -r requirements.txt

      - name: Install azd
        run: curl -fsSL https://aka.ms/install-azd.sh | bash

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Configure azd environment
        run: |
          azd config set auth.useAzCliAuth true
          azd env new ${{ needs.validate.outputs.environment_name }} --no-prompt || true
          azd env select ${{ needs.validate.outputs.environment_name }}
          
          # Set required environment variables
          azd env set AZURE_LOCATION "${{ vars.AZURE_LOCATION_PRIMARY }}"
          azd env set AZURE_SUBSCRIPTION_ID "${{ secrets.AZURE_SUBSCRIPTION_ID }}"
          
          # Set secondary location if configured
          if [ -n "${{ vars.AZURE_LOCATION_SECONDARY }}" ]; then
            azd env set AZURE_LOCATION_SECONDARY "${{ vars.AZURE_LOCATION_SECONDARY }}"
          fi

      - name: Run pre-provision hooks
        if: github.event.inputs.skip_hooks != 'true'
        run: |
          echo "Running pre-provision scripts..."
          python scripts/preprovision_read_model_config.py || true
          python scripts/preprovision_register_providers.py || true
          python scripts/preprovision_purge_soft_deleted.py || true
        env:
          AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          AZURE_ENV_NAME: ${{ needs.validate.outputs.environment_name }}
          AZURE_LOCATION: ${{ vars.AZURE_LOCATION_PRIMARY }}
          AZURE_LOCATION_SECONDARY: ${{ vars.AZURE_LOCATION_SECONDARY }}

      - name: Refresh Azure Login (for long-running provision)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Provision infrastructure
        run: |
          azd provision --no-prompt
        env:
          AZURE_ENV_NAME: ${{ needs.validate.outputs.environment_name }}
          AZURE_LOCATION: ${{ vars.AZURE_LOCATION_PRIMARY }}
          AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Ensure App Service Plan SKU (B1 Basic)
        run: |
          echo "Ensuring App Service Plans are on B1 Basic tier..."
          echo "Note: azd may skip SKU updates if resources already exist"
          
          ENV_NAME="${{ needs.validate.outputs.environment_name }}"
          PRIMARY_RG="rg-bing-grounding-mcp-${ENV_NAME}"
          SECONDARY_RG="rg-bing-grounding-mcp-${ENV_NAME}-secondary"
          
          # Function to update ASP SKU if needed
          update_asp_sku() {
            local RG="$1"
            local REGION_NAME="$2"
            
            # Get App Service Plan name
            ASP_NAME=$(az appservice plan list --resource-group "$RG" --query "[0].name" -o tsv 2>/dev/null || echo "")
            
            if [ -z "$ASP_NAME" ]; then
              echo "  âš ï¸ No App Service Plan found in $RG"
              return
            fi
            
            # Get current SKU
            CURRENT_SKU=$(az appservice plan show --name "$ASP_NAME" --resource-group "$RG" --query "sku.name" -o tsv 2>/dev/null || echo "")
            echo "  ðŸ“ $REGION_NAME: $ASP_NAME (current SKU: $CURRENT_SKU)"
            
            if [ "$CURRENT_SKU" != "B1" ]; then
              echo "  ðŸ”„ Updating $ASP_NAME from $CURRENT_SKU to B1..."
              az appservice plan update \
                --name "$ASP_NAME" \
                --resource-group "$RG" \
                --sku B1 \
                --output none
              echo "  âœ… Updated $ASP_NAME to B1 Basic"
            else
              echo "  âœ… $ASP_NAME already on B1 Basic"
            fi
          }
          
          # Update primary region
          echo ""
          echo "=== Primary Region ==="
          update_asp_sku "$PRIMARY_RG" "Primary"
          
          # Update secondary region if configured
          if [ -n "${{ vars.AZURE_LOCATION_SECONDARY }}" ]; then
            echo ""
            echo "=== Secondary Region ==="
            update_asp_sku "$SECONDARY_RG" "Secondary"
          fi
          
          echo ""
          echo "âœ… App Service Plan SKU verification complete"

      - name: Create Bing Grounding resources
        run: |
          echo "Creating Bing Grounding resources for each region..."
          
          ENV_NAME="${{ needs.validate.outputs.environment_name }}"
          PRIMARY_RG="rg-bing-grounding-mcp-${ENV_NAME}"
          SECONDARY_RG="rg-bing-grounding-mcp-${ENV_NAME}-secondary"
          
          # Create Bing Grounding for primary region
          echo "Creating Bing Grounding for primary region..."
          BING_NAME_PRIMARY="bing-grounding-${ENV_NAME}"
          
          # Check if already exists
          if az resource show --resource-group "$PRIMARY_RG" --name "$BING_NAME_PRIMARY" --resource-type "Microsoft.Bing/accounts" &>/dev/null; then
            echo "âœ… Bing resource already exists in primary region: $BING_NAME_PRIMARY"
          else
            echo "Creating Bing resource in primary region..."
            az resource create \
              --resource-group "$PRIMARY_RG" \
              --name "$BING_NAME_PRIMARY" \
              --resource-type "Microsoft.Bing/accounts" \
              --is-full-object \
              --properties '{"kind": "Bing.Grounding", "location": "global", "sku": {"name": "G1"}, "properties": {}}'
            echo "âœ… Created Bing resource: $BING_NAME_PRIMARY"
          fi
          
          # Get primary Bing resource ID
          PRIMARY_BING_ID=$(az resource show --resource-group "$PRIMARY_RG" --name "$BING_NAME_PRIMARY" --resource-type "Microsoft.Bing/accounts" --query id -o tsv)
          echo "Primary Bing Resource ID: $PRIMARY_BING_ID"
          azd env set BING_GROUNDING_RESOURCE_ID "$PRIMARY_BING_ID"
          
          # Create Bing Grounding for secondary region if configured
          if [ -n "${{ vars.AZURE_LOCATION_SECONDARY }}" ]; then
            echo "Creating Bing Grounding for secondary region..."
            BING_NAME_SECONDARY="bing-grounding-${ENV_NAME}-secondary"
            
            if az resource show --resource-group "$SECONDARY_RG" --name "$BING_NAME_SECONDARY" --resource-type "Microsoft.Bing/accounts" &>/dev/null; then
              echo "âœ… Bing resource already exists in secondary region: $BING_NAME_SECONDARY"
            else
              echo "Creating Bing resource in secondary region..."
              az resource create \
                --resource-group "$SECONDARY_RG" \
                --name "$BING_NAME_SECONDARY" \
                --resource-type "Microsoft.Bing/accounts" \
                --is-full-object \
                --properties '{"kind": "Bing.Grounding", "location": "global", "sku": {"name": "G1"}, "properties": {}}'
              echo "âœ… Created Bing resource: $BING_NAME_SECONDARY"
            fi
            
            # Get secondary Bing resource ID
            SECONDARY_BING_ID=$(az resource show --resource-group "$SECONDARY_RG" --name "$BING_NAME_SECONDARY" --resource-type "Microsoft.Bing/accounts" --query id -o tsv)
            echo "Secondary Bing Resource ID: $SECONDARY_BING_ID"
            azd env set BING_GROUNDING_RESOURCE_ID_SECONDARY "$SECONDARY_BING_ID"
          fi

      - name: Configure service principal permissions
        run: |
          echo "Configuring service principal permissions for AI Foundry and Agents API..."
          
          ENV_NAME="${{ needs.validate.outputs.environment_name }}"
          PRIMARY_RG="rg-bing-grounding-mcp-${ENV_NAME}"
          SECONDARY_RG="rg-bing-grounding-mcp-${ENV_NAME}-secondary"
          
          # Get the service principal object ID (required for role assignments)
          SP_OBJECT_ID=$(az ad sp show --id "${{ secrets.AZURE_CLIENT_ID }}" --query id -o tsv)
          echo "Service Principal Object ID: $SP_OBJECT_ID"
          
          # Function to assign roles to a resource
          assign_roles() {
            local RESOURCE_ID="$1"
            local RESOURCE_NAME="$2"
            
            if [ -z "$RESOURCE_ID" ]; then
              echo "âš ï¸ No resource ID provided for $RESOURCE_NAME, skipping..."
              return
            fi
            
            echo "Assigning roles to $RESOURCE_NAME..."
            
            # Azure AI Developer - Required for Agents API (data plane)
            # Includes: agents/read, agents/write, threads/*, messages/*, runs/*
            az role assignment create \
              --role "Azure AI Developer" \
              --assignee-object-id "$SP_OBJECT_ID" \
              --assignee-principal-type ServicePrincipal \
              --scope "$RESOURCE_ID" \
              2>/dev/null && echo "  âœ… Azure AI Developer assigned" || echo "  â„¹ï¸ Azure AI Developer may already be assigned"
            
            # Cognitive Services User - Required for model deployments
            az role assignment create \
              --role "Cognitive Services User" \
              --assignee-object-id "$SP_OBJECT_ID" \
              --assignee-principal-type ServicePrincipal \
              --scope "$RESOURCE_ID" \
              2>/dev/null && echo "  âœ… Cognitive Services User assigned" || echo "  â„¹ï¸ Cognitive Services User may already be assigned"
          }
          
          # === Primary Region ===
          echo ""
          echo "=== Primary Region: $PRIMARY_RG ==="
          
          # AI Foundry (AI Services account)
          PRIMARY_FOUNDRY_ID=$(az cognitiveservices account list --resource-group "$PRIMARY_RG" --query "[?kind=='AIServices'].id | [0]" -o tsv 2>/dev/null || echo "")
          if [ -n "$PRIMARY_FOUNDRY_ID" ]; then
            assign_roles "$PRIMARY_FOUNDRY_ID" "Primary AI Foundry"
          fi
          
          # AI Project (child resource of AI Services)
          PRIMARY_PROJECT_ID=$(az resource list --resource-group "$PRIMARY_RG" --resource-type "Microsoft.CognitiveServices/accounts/projects" --query "[0].id" -o tsv 2>/dev/null || echo "")
          if [ -n "$PRIMARY_PROJECT_ID" ]; then
            assign_roles "$PRIMARY_PROJECT_ID" "Primary AI Project"
          fi
          
          # === Secondary Region (if configured) ===
          if [ -n "${{ vars.AZURE_LOCATION_SECONDARY }}" ]; then
            echo ""
            echo "=== Secondary Region: $SECONDARY_RG ==="
            
            # AI Foundry
            SECONDARY_FOUNDRY_ID=$(az cognitiveservices account list --resource-group "$SECONDARY_RG" --query "[?kind=='AIServices'].id | [0]" -o tsv 2>/dev/null || echo "")
            if [ -n "$SECONDARY_FOUNDRY_ID" ]; then
              assign_roles "$SECONDARY_FOUNDRY_ID" "Secondary AI Foundry"
            fi
            
            # AI Project
            SECONDARY_PROJECT_ID=$(az resource list --resource-group "$SECONDARY_RG" --resource-type "Microsoft.CognitiveServices/accounts/projects" --query "[0].id" -o tsv 2>/dev/null || echo "")
            if [ -n "$SECONDARY_PROJECT_ID" ]; then
              assign_roles "$SECONDARY_PROJECT_ID" "Secondary AI Project"
            fi
          fi
          
          echo ""
          echo "âœ… Service principal permissions configured"
          echo "Note: Role assignments may take 1-2 minutes to propagate"

      - name: Run post-provision hooks
        if: github.event.inputs.skip_hooks != 'true'
        run: |
          echo "Running post-provision scripts..."
          python scripts/postprovision_deploy_bing_connection.py || true
          # Note: Model deployment and agent creation moved to app deploy workflow (deploy.yml)
        env:
          AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          AZURE_ENV_NAME: ${{ needs.validate.outputs.environment_name }}

      - name: Auto-configure GitHub Environment Variables
        run: |
          echo "=========================================================================="
          echo "Configuring GitHub Environment Variables"
          echo "=========================================================================="
          echo ""
          
          ENV_NAME="${{ needs.validate.outputs.environment_name }}"
          REPO="${{ github.repository }}"
          PRIMARY_RG="rg-bing-grounding-mcp-${ENV_NAME}"
          SECONDARY_RG="rg-bing-grounding-mcp-${ENV_NAME}-secondary"
          
          echo "ðŸ“ Repository: $REPO"
          echo "ðŸ“ Environment: $ENV_NAME"
          echo ""
          
          # Get primary region values
          echo "ðŸ“‹ Primary Region: $PRIMARY_RG"
          PRIMARY_WEBAPP=$(az webapp list --resource-group "$PRIMARY_RG" --query "[0].name" -o tsv 2>/dev/null || echo "")
          PRIMARY_ENDPOINT=$(az cognitiveservices account list --resource-group "$PRIMARY_RG" --query "[?kind=='AIServices'].properties.endpoint | [0]" -o tsv 2>/dev/null || echo "")
          PRIMARY_FOUNDRY=$(az cognitiveservices account list --resource-group "$PRIMARY_RG" --query "[?kind=='AIServices'].name | [0]" -o tsv 2>/dev/null || echo "")
          PRIMARY_BING_ID=$(az resource list --resource-group "$PRIMARY_RG" --resource-type "Microsoft.Bing/accounts" --query "[0].id" -o tsv 2>/dev/null || echo "")
          
          echo "  Web App: $PRIMARY_WEBAPP"
          echo "  AI Endpoint: $PRIMARY_ENDPOINT"
          echo "  AI Foundry: $PRIMARY_FOUNDRY"
          echo "  Resource Group: $PRIMARY_RG"
          echo "  Bing ID: $PRIMARY_BING_ID"
          echo ""
          
          # Set primary region variables
          echo "ðŸ”„ Setting primary region variables..."
          gh variable set AZURE_WEBAPP_NAME_PRIMARY --body "$PRIMARY_WEBAPP" --env "$ENV_NAME" --repo "$REPO"
          echo "  âœ… AZURE_WEBAPP_NAME_PRIMARY"
          gh variable set AZURE_AI_PROJECT_ENDPOINT_PRIMARY --body "$PRIMARY_ENDPOINT" --env "$ENV_NAME" --repo "$REPO"
          echo "  âœ… AZURE_AI_PROJECT_ENDPOINT_PRIMARY"
          gh variable set AZURE_FOUNDRY_NAME_PRIMARY --body "$PRIMARY_FOUNDRY" --env "$ENV_NAME" --repo "$REPO"
          echo "  âœ… AZURE_FOUNDRY_NAME_PRIMARY"
          gh variable set AZURE_RESOURCE_GROUP_PRIMARY --body "$PRIMARY_RG" --env "$ENV_NAME" --repo "$REPO"
          echo "  âœ… AZURE_RESOURCE_GROUP_PRIMARY"
          gh variable set BING_GROUNDING_RESOURCE_ID_PRIMARY --body "$PRIMARY_BING_ID" --env "$ENV_NAME" --repo "$REPO"
          echo "  âœ… BING_GROUNDING_RESOURCE_ID_PRIMARY"
          echo ""
          
          # Get secondary region values
          echo "ðŸ“‹ Secondary Region: $SECONDARY_RG"
          SECONDARY_WEBAPP=$(az webapp list --resource-group "$SECONDARY_RG" --query "[0].name" -o tsv 2>/dev/null || echo "")
          
          if [ -n "$SECONDARY_WEBAPP" ]; then
            SECONDARY_ENDPOINT=$(az cognitiveservices account list --resource-group "$SECONDARY_RG" --query "[?kind=='AIServices'].properties.endpoint | [0]" -o tsv 2>/dev/null || echo "")
            SECONDARY_FOUNDRY=$(az cognitiveservices account list --resource-group "$SECONDARY_RG" --query "[?kind=='AIServices'].name | [0]" -o tsv 2>/dev/null || echo "")
            SECONDARY_BING_ID=$(az resource list --resource-group "$SECONDARY_RG" --resource-type "Microsoft.Bing/accounts" --query "[0].id" -o tsv 2>/dev/null || echo "")
            
            echo "  Web App: $SECONDARY_WEBAPP"
            echo "  AI Endpoint: $SECONDARY_ENDPOINT"
            echo "  AI Foundry: $SECONDARY_FOUNDRY"
            echo "  Resource Group: $SECONDARY_RG"
            echo "  Bing ID: $SECONDARY_BING_ID"
            echo ""
            
            echo "ðŸ”„ Setting secondary region variables..."
            gh variable set AZURE_WEBAPP_NAME_SECONDARY --body "$SECONDARY_WEBAPP" --env "$ENV_NAME" --repo "$REPO"
            echo "  âœ… AZURE_WEBAPP_NAME_SECONDARY"
            gh variable set AZURE_AI_PROJECT_ENDPOINT_SECONDARY --body "$SECONDARY_ENDPOINT" --env "$ENV_NAME" --repo "$REPO"
            echo "  âœ… AZURE_AI_PROJECT_ENDPOINT_SECONDARY"
            gh variable set AZURE_FOUNDRY_NAME_SECONDARY --body "$SECONDARY_FOUNDRY" --env "$ENV_NAME" --repo "$REPO"
            echo "  âœ… AZURE_FOUNDRY_NAME_SECONDARY"
            gh variable set AZURE_RESOURCE_GROUP_SECONDARY --body "$SECONDARY_RG" --env "$ENV_NAME" --repo "$REPO"
            echo "  âœ… AZURE_RESOURCE_GROUP_SECONDARY"
            gh variable set BING_GROUNDING_RESOURCE_ID_SECONDARY --body "$SECONDARY_BING_ID" --env "$ENV_NAME" --repo "$REPO"
            echo "  âœ… BING_GROUNDING_RESOURCE_ID_SECONDARY"
          else
            echo "  âš ï¸  No secondary region resources (single-region deployment)"
          fi
          
          echo ""
          echo "=========================================================================="
          echo "âœ… GitHub environment '$ENV_NAME' configured automatically!"
          echo "=========================================================================="
          echo ""
          echo "ðŸ”— View at: https://github.com/$REPO/settings/environments"
          echo ""
          echo "Next step:"
          echo "  gh workflow run deploy.yml --field environment=$ENV_NAME"
          echo ""
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}

      - name: Output provisioned resources
        run: |
          echo "## ðŸš€ Provision Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Configuration
          echo "### Configuration" >> $GITHUB_STEP_SUMMARY
          echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ needs.validate.outputs.environment_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Primary Region | ${{ vars.AZURE_LOCATION_PRIMARY }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Secondary Region | ${{ vars.AZURE_LOCATION_SECONDARY }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Get values directly from Azure (more reliable than azd env)
          PRIMARY_RG="rg-bing-grounding-mcp-${{ needs.validate.outputs.environment_name }}"
          SECONDARY_RG="rg-bing-grounding-mcp-${{ needs.validate.outputs.environment_name }}-secondary"
          
          # Primary region resources
          echo "### ðŸ“‹ Primary Region Resources" >> $GITHUB_STEP_SUMMARY
          PRIMARY_WEBAPP=$(az webapp list --resource-group $PRIMARY_RG --query "[0].name" -o tsv 2>/dev/null || echo "")
          PRIMARY_FOUNDRY=$(az cognitiveservices account list --resource-group $PRIMARY_RG --query "[?kind=='AIServices'].name | [0]" -o tsv 2>/dev/null || echo "")
          PRIMARY_ENDPOINT=$(az cognitiveservices account list --resource-group $PRIMARY_RG --query "[?kind=='AIServices'].properties.endpoint | [0]" -o tsv 2>/dev/null || echo "")
          PRIMARY_BING=$(az resource list --resource-group $PRIMARY_RG --resource-type "Microsoft.Bing/accounts" --query "[0].name" -o tsv 2>/dev/null || echo "")
          PRIMARY_BING_ID=$(az resource list --resource-group $PRIMARY_RG --resource-type "Microsoft.Bing/accounts" --query "[0].id" -o tsv 2>/dev/null || echo "")
          
          echo "| Resource | Name |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| Resource Group | $PRIMARY_RG |" >> $GITHUB_STEP_SUMMARY
          echo "| Web App | $PRIMARY_WEBAPP |" >> $GITHUB_STEP_SUMMARY
          echo "| AI Foundry | $PRIMARY_FOUNDRY |" >> $GITHUB_STEP_SUMMARY
          echo "| Bing Grounding | $PRIMARY_BING |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Secondary region resources (if exists)
          SECONDARY_WEBAPP=$(az webapp list --resource-group $SECONDARY_RG --query "[0].name" -o tsv 2>/dev/null || echo "")
          SECONDARY_FOUNDRY=$(az cognitiveservices account list --resource-group $SECONDARY_RG --query "[?kind=='AIServices'].name | [0]" -o tsv 2>/dev/null || echo "")
          SECONDARY_ENDPOINT=$(az cognitiveservices account list --resource-group $SECONDARY_RG --query "[?kind=='AIServices'].properties.endpoint | [0]" -o tsv 2>/dev/null || echo "")
          SECONDARY_BING=$(az resource list --resource-group $SECONDARY_RG --resource-type "Microsoft.Bing/accounts" --query "[0].name" -o tsv 2>/dev/null || echo "")
          SECONDARY_BING_ID=$(az resource list --resource-group $SECONDARY_RG --resource-type "Microsoft.Bing/accounts" --query "[0].id" -o tsv 2>/dev/null || echo "")
          
          if [ -n "$SECONDARY_WEBAPP" ]; then
            echo "### ðŸ“‹ Secondary Region Resources" >> $GITHUB_STEP_SUMMARY
            echo "| Resource | Name |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|------|" >> $GITHUB_STEP_SUMMARY
            echo "| Resource Group | $SECONDARY_RG |" >> $GITHUB_STEP_SUMMARY
            echo "| Web App | $SECONDARY_WEBAPP |" >> $GITHUB_STEP_SUMMARY
            echo "| AI Foundry | $SECONDARY_FOUNDRY |" >> $GITHUB_STEP_SUMMARY
            echo "| Bing Grounding | $SECONDARY_BING |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # GitHub Environment Variables - CLEAN format for easy copy/paste
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "## âš ï¸ Required: GitHub Environment Configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Go to:** [GitHub Settings â†’ Environments â†’ \`${{ needs.validate.outputs.environment_name }}\`](https://github.com/${{ github.repository }}/settings/environments)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Create environment \`${{ needs.validate.outputs.environment_name }}\` and add these 6 variables:**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Primary region - show values in code blocks for easy copying
          echo "### ðŸ”µ Primary Region Variables" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "Variable: AZURE_WEBAPP_NAME_PRIMARY" >> $GITHUB_STEP_SUMMARY
          echo "Value:    $PRIMARY_WEBAPP" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "Variable: AZURE_AI_PROJECT_ENDPOINT_PRIMARY" >> $GITHUB_STEP_SUMMARY
          echo "Value:    $PRIMARY_ENDPOINT" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "Variable: BING_GROUNDING_RESOURCE_ID_PRIMARY" >> $GITHUB_STEP_SUMMARY
          echo "Value:    $PRIMARY_BING_ID" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Secondary region (if exists)
          if [ -n "$SECONDARY_WEBAPP" ]; then
            echo "### ðŸŸ¢ Secondary Region Variables" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "Variable: AZURE_WEBAPP_NAME_SECONDARY" >> $GITHUB_STEP_SUMMARY
            echo "Value:    $SECONDARY_WEBAPP" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "Variable: AZURE_AI_PROJECT_ENDPOINT_SECONDARY" >> $GITHUB_STEP_SUMMARY
            echo "Value:    $SECONDARY_ENDPOINT" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "Variable: BING_GROUNDING_RESOURCE_ID_SECONDARY" >> $GITHUB_STEP_SUMMARY
            echo "Value:    $SECONDARY_BING_ID" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "## âœ… Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. **Copy the values above** to GitHub environment \`${{ needs.validate.outputs.environment_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "2. **Deploy application:**" >> $GITHUB_STEP_SUMMARY
          echo '   ```bash' >> $GITHUB_STEP_SUMMARY
          echo "   gh workflow run deploy.yml --field environment=${{ needs.validate.outputs.environment_name }}" >> $GITHUB_STEP_SUMMARY
          echo '   ```' >> $GITHUB_STEP_SUMMARY

  deploy:
    name: Deploy Application
    needs: [validate, provision]
    runs-on: ubuntu-latest
    if: |
      always() && 
      (github.event.inputs.action == 'deploy' || github.event.inputs.action == 'up') &&
      (needs.provision.result == 'success' || needs.provision.result == 'skipped')
    environment:
      name: ${{ needs.validate.outputs.environment_name }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Python dependencies
        run: pip install -r requirements.txt

      - name: Install azd
        run: curl -fsSL https://aka.ms/install-azd.sh | bash

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Configure azd environment
        run: |
          azd config set auth.useAzCliAuth true
          azd env select ${{ needs.validate.outputs.environment_name }} || \
            azd env new ${{ needs.validate.outputs.environment_name }} --no-prompt
          
          azd env set AZURE_LOCATION "${{ vars.AZURE_LOCATION_PRIMARY }}"
          azd env set AZURE_SUBSCRIPTION_ID "${{ secrets.AZURE_SUBSCRIPTION_ID }}"

      - name: Deploy application
        run: |
          azd deploy --no-prompt
        env:
          AZURE_ENV_NAME: ${{ needs.validate.outputs.environment_name }}
          AZURE_LOCATION: ${{ vars.AZURE_LOCATION_PRIMARY }}
          AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Run post-deploy hooks
        if: github.event.inputs.skip_hooks != 'true'
        run: |
          echo "Running post-deploy scripts..."
          python scripts/postdeploy_configure_appservice.py || true
        env:
          AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          AZURE_ENV_NAME: ${{ needs.validate.outputs.environment_name }}

  teardown:
    name: Tear Down Infrastructure
    needs: validate
    runs-on: ubuntu-latest
    if: github.event.inputs.action == 'down'
    environment:
      name: ${{ needs.validate.outputs.environment_name }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install azd
        run: curl -fsSL https://aka.ms/install-azd.sh | bash

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Configure azd environment
        run: |
          azd config set auth.useAzCliAuth true
          azd env select ${{ needs.validate.outputs.environment_name }}

      - name: Confirm teardown
        run: |
          echo "âš ï¸ WARNING: This will delete all resources in environment: ${{ needs.validate.outputs.environment_name }}"
          echo ""
          echo "Resources to be deleted:"
          azd env get-values | grep -E "^AZURE_" || true

      - name: Tear down infrastructure
        run: |
          azd down --force --purge --no-prompt
        env:
          AZURE_ENV_NAME: ${{ needs.validate.outputs.environment_name }}
          AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Summary
        run: |
          echo "## Teardown Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Environment **${{ needs.validate.outputs.environment_name }}** has been deleted." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ Note: Some resources may be soft-deleted. Use Azure Portal to purge if needed." >> $GITHUB_STEP_SUMMARY

  summary:
    name: Workflow Summary
    needs: [validate, provision, deploy, teardown, what-if]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Generate summary
        run: |
          echo "## Infrastructure Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| What-If | ${{ needs.what-if.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Provision | ${{ needs.provision.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy | ${{ needs.deploy.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Teardown | ${{ needs.teardown.result }} |" >> $GITHUB_STEP_SUMMARY
      
      - name: Azure Login
        if: needs.provision.result == 'success'
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      
      - name: Generate Environment Configuration Files
        if: needs.provision.result == 'success'
        run: |
          ENV_NAME="${{ needs.validate.outputs.environment_name }}"
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸš€ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 1. Create Local Environment Files" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Get resources for primary
          PRIMARY_RG="rg-bing-grounding-mcp-${ENV_NAME}-primary"
          SECONDARY_RG="rg-bing-grounding-mcp-${ENV_NAME}-secondary"
          
          # Primary environment
          PRIMARY_WEBAPP=$(az webapp list -g $PRIMARY_RG --query "[0].name" -o tsv || echo "app-${ENV_NAME}-primary-xxxxx")
          PRIMARY_AI_ENDPOINT=$(az cognitiveservices account list -g $PRIMARY_RG --query "[?kind=='AIServices'].properties.endpoint | [0]" -o tsv || echo "https://ai-foundry-${ENV_NAME}-primary-xxxxx.cognitiveservices.azure.com/")
          PRIMARY_AI_PROJECT=$(az cognitiveservices account list -g $PRIMARY_RG --query "[?kind=='AIServices'].name | [0]" -o tsv || echo "ai-proj-${ENV_NAME}-primary-xxxxx")
          PRIMARY_REGION=$(az group show -n $PRIMARY_RG --query location -o tsv || echo "eastus2")
          
          # Secondary environment
          SECONDARY_WEBAPP=$(az webapp list -g $SECONDARY_RG --query "[0].name" -o tsv || echo "app-${ENV_NAME}-secondary-xxxxx")
          SECONDARY_AI_ENDPOINT=$(az cognitiveservices account list -g $SECONDARY_RG --query "[?kind=='AIServices'].properties.endpoint | [0]" -o tsv || echo "https://ai-foundry-${ENV_NAME}-secondary-xxxxx.cognitiveservices.azure.com/")
          SECONDARY_AI_PROJECT=$(az cognitiveservices account list -g $SECONDARY_RG --query "[?kind=='AIServices'].name | [0]" -o tsv || echo "ai-proj-${ENV_NAME}-secondary-xxxxx")
          SECONDARY_REGION=$(az group show -n $SECONDARY_RG --query location -o tsv || echo "westus2")
          
          echo "Create \`.env.${ENV_NAME}_primary\`:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "AZURE_ENV_NAME=${ENV_NAME}" >> $GITHUB_STEP_SUMMARY
          echo "WEBAPP_NAME=${PRIMARY_WEBAPP}" >> $GITHUB_STEP_SUMMARY
          echo "AI_PROJECT_ENDPOINT=${PRIMARY_AI_ENDPOINT}" >> $GITHUB_STEP_SUMMARY
          echo "AI_PROJECT_NAME=${PRIMARY_AI_PROJECT}" >> $GITHUB_STEP_SUMMARY
          echo "REGION=${PRIMARY_REGION}" >> $GITHUB_STEP_SUMMARY
          echo "RESOURCE_GROUP=${PRIMARY_RG}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "Create \`.env.${ENV_NAME}_secondary\`:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "AZURE_ENV_NAME=${ENV_NAME}" >> $GITHUB_STEP_SUMMARY
          echo "WEBAPP_NAME=${SECONDARY_WEBAPP}" >> $GITHUB_STEP_SUMMARY
          echo "AI_PROJECT_ENDPOINT=${SECONDARY_AI_ENDPOINT}" >> $GITHUB_STEP_SUMMARY
          echo "AI_PROJECT_NAME=${SECONDARY_AI_PROJECT}" >> $GITHUB_STEP_SUMMARY
          echo "REGION=${SECONDARY_REGION}" >> $GITHUB_STEP_SUMMARY
          echo "RESOURCE_GROUP=${SECONDARY_RG}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### 2. Sync to GitHub" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "python configure/sync_github_env_simple.py --environment ${ENV_NAME}_primary" >> $GITHUB_STEP_SUMMARY
          echo "python configure/sync_github_env_simple.py --environment ${ENV_NAME}_secondary" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### 3. Deploy Application" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "gh workflow run deploy.yml --field environment=${ENV_NAME}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

