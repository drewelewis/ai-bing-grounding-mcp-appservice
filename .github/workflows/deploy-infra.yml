# Deploy Infrastructure with Azure Developer CLI (azd)
#
# This workflow provisions Azure infrastructure using azd and Bicep templates.
# Supports multi-region deployments with AI Foundry, App Service, and APIM.
#
# Required secrets:
#   AZURE_CLIENT_ID       - Service principal app ID (for OIDC)
#   AZURE_TENANT_ID       - Azure AD tenant ID
#   AZURE_SUBSCRIPTION_ID - Azure subscription ID
#
# Required variables:
#   AZURE_ENV_NAME             - azd environment name (e.g., "prod", "dev")
#   AZURE_LOCATION_PRIMARY     - Primary region (e.g., "eastus2")
#
# Optional variables:
#   AZURE_LOCATION_SECONDARY - Secondary region (e.g., "westus2")

name: Deploy Infrastructure

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - provision      # Provision infrastructure only
          - deploy         # Deploy app only (after provision)
          - up             # Full provision + deploy
          - down           # Tear down infrastructure
          - what-if        # Preview changes without applying
      
      environment:
        description: 'Target environment'
        required: true
        type: choice
        default: 'prod'
        options:
          - prod
          - staging
          - dev
      
      skip_hooks:
        description: 'Skip pre/post provision hooks'
        required: false
        type: boolean
        default: false

# Required for OIDC authentication with Azure
permissions:
  id-token: write
  contents: read

env:
  PYTHON_VERSION: '3.11'
  AZD_VERSION: 'latest'

jobs:
  validate:
    name: Validate Inputs
    runs-on: ubuntu-latest
    outputs:
      environment_name: ${{ steps.set-env.outputs.environment_name }}
    
    steps:
      - name: Set environment name
        id: set-env
        run: |
          # Use input environment or fall back to variable
          ENV_NAME="${{ github.event.inputs.environment }}"
          if [ -z "$ENV_NAME" ]; then
            ENV_NAME="${{ vars.AZURE_ENV_NAME }}"
          fi
          echo "environment_name=$ENV_NAME" >> $GITHUB_OUTPUT
          echo "ðŸ“ Environment: $ENV_NAME"

  what-if:
    name: Preview Changes (What-If)
    needs: validate
    runs-on: ubuntu-latest
    if: github.event.inputs.action == 'what-if'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install azd
        run: curl -fsSL https://aka.ms/install-azd.sh | bash

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Configure azd environment
        run: |
          azd config set auth.useAzCliAuth true
          azd env new ${{ needs.validate.outputs.environment_name }} --no-prompt || true
          azd env select ${{ needs.validate.outputs.environment_name }}
          
          # Set location
          azd env set AZURE_LOCATION "${{ vars.AZURE_LOCATION_PRIMARY }}"
          
          # Set secondary location if configured
          if [ -n "${{ vars.AZURE_LOCATION_SECONDARY }}" ]; then
            azd env set AZURE_LOCATION_SECONDARY "${{ vars.AZURE_LOCATION_SECONDARY }}"
          fi

      - name: Preview infrastructure changes
        run: |
          echo "## Infrastructure Preview (What-If)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Run Bicep what-if
          az deployment sub what-if \
            --location "${{ vars.AZURE_LOCATION_PRIMARY }}" \
            --template-file infra/main.bicep \
            --parameters infra/main.parameters.json \
            --parameters environmentName=${{ needs.validate.outputs.environment_name }} \
            >> $GITHUB_STEP_SUMMARY 2>&1 || true

  provision:
    name: Provision Infrastructure
    needs: validate
    runs-on: ubuntu-latest
    if: github.event.inputs.action == 'provision' || github.event.inputs.action == 'up'
    environment:
      name: ${{ needs.validate.outputs.environment_name }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Python dependencies
        run: pip install -r requirements.txt

      - name: Install azd
        run: curl -fsSL https://aka.ms/install-azd.sh | bash

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Configure azd environment
        run: |
          azd config set auth.useAzCliAuth true
          azd env new ${{ needs.validate.outputs.environment_name }} --no-prompt || true
          azd env select ${{ needs.validate.outputs.environment_name }}
          
          # Set required environment variables
          azd env set AZURE_LOCATION "${{ vars.AZURE_LOCATION_PRIMARY }}"
          azd env set AZURE_SUBSCRIPTION_ID "${{ secrets.AZURE_SUBSCRIPTION_ID }}"
          
          # Set secondary location if configured
          if [ -n "${{ vars.AZURE_LOCATION_SECONDARY }}" ]; then
            azd env set AZURE_LOCATION_SECONDARY "${{ vars.AZURE_LOCATION_SECONDARY }}"
          fi

      - name: Run pre-provision hooks
        if: github.event.inputs.skip_hooks != 'true'
        run: |
          echo "Running pre-provision scripts..."
          python scripts/preprovision_read_model_config.py || true
          python scripts/preprovision_register_providers.py || true
        env:
          AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Provision infrastructure
        run: |
          azd provision --no-prompt
        env:
          AZURE_ENV_NAME: ${{ needs.validate.outputs.environment_name }}
          AZURE_LOCATION: ${{ vars.AZURE_LOCATION_PRIMARY }}
          AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Create Bing Grounding resources
        run: |
          echo "Creating Bing Grounding resources for each region..."
          
          ENV_NAME="${{ needs.validate.outputs.environment_name }}"
          PRIMARY_RG="rg-bing-grounding-mcp-${ENV_NAME}"
          SECONDARY_RG="rg-bing-grounding-mcp-${ENV_NAME}-secondary"
          
          # Create Bing Grounding for primary region
          echo "Creating Bing Grounding for primary region..."
          BING_NAME_PRIMARY="bing-grounding-${ENV_NAME}"
          
          # Check if already exists
          if az resource show --resource-group "$PRIMARY_RG" --name "$BING_NAME_PRIMARY" --resource-type "Microsoft.Bing/accounts" &>/dev/null; then
            echo "âœ… Bing resource already exists in primary region: $BING_NAME_PRIMARY"
          else
            echo "Creating Bing resource in primary region..."
            az resource create \
              --resource-group "$PRIMARY_RG" \
              --name "$BING_NAME_PRIMARY" \
              --resource-type "Microsoft.Bing/accounts" \
              --is-full-object \
              --properties '{"kind": "Bing.Grounding", "location": "global", "sku": {"name": "G1"}, "properties": {}}'
            echo "âœ… Created Bing resource: $BING_NAME_PRIMARY"
          fi
          
          # Get primary Bing resource ID
          PRIMARY_BING_ID=$(az resource show --resource-group "$PRIMARY_RG" --name "$BING_NAME_PRIMARY" --resource-type "Microsoft.Bing/accounts" --query id -o tsv)
          echo "Primary Bing Resource ID: $PRIMARY_BING_ID"
          azd env set BING_GROUNDING_RESOURCE_ID "$PRIMARY_BING_ID"
          
          # Create Bing Grounding for secondary region if configured
          if [ -n "${{ vars.AZURE_LOCATION_SECONDARY }}" ]; then
            echo "Creating Bing Grounding for secondary region..."
            BING_NAME_SECONDARY="bing-grounding-${ENV_NAME}-secondary"
            
            if az resource show --resource-group "$SECONDARY_RG" --name "$BING_NAME_SECONDARY" --resource-type "Microsoft.Bing/accounts" &>/dev/null; then
              echo "âœ… Bing resource already exists in secondary region: $BING_NAME_SECONDARY"
            else
              echo "Creating Bing resource in secondary region..."
              az resource create \
                --resource-group "$SECONDARY_RG" \
                --name "$BING_NAME_SECONDARY" \
                --resource-type "Microsoft.Bing/accounts" \
                --is-full-object \
                --properties '{"kind": "Bing.Grounding", "location": "global", "sku": {"name": "G1"}, "properties": {}}'
              echo "âœ… Created Bing resource: $BING_NAME_SECONDARY"
            fi
            
            # Get secondary Bing resource ID
            SECONDARY_BING_ID=$(az resource show --resource-group "$SECONDARY_RG" --name "$BING_NAME_SECONDARY" --resource-type "Microsoft.Bing/accounts" --query id -o tsv)
            echo "Secondary Bing Resource ID: $SECONDARY_BING_ID"
            azd env set BING_GROUNDING_RESOURCE_ID_SECONDARY "$SECONDARY_BING_ID"
          fi

      - name: Run post-provision hooks
        if: github.event.inputs.skip_hooks != 'true'
        run: |
          echo "Running post-provision scripts..."
          python scripts/postprovision_deploy_models.py || true
          python scripts/postprovision_deploy_bing_connection.py || true
          # Note: Agent creation moved to app deploy workflow (deploy.yml)
        env:
          AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          AZURE_ENV_NAME: ${{ needs.validate.outputs.environment_name }}

      - name: Output provisioned resources
        run: |
          echo "## ðŸš€ Provision Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Configuration
          echo "### Configuration" >> $GITHUB_STEP_SUMMARY
          echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ needs.validate.outputs.environment_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Primary Region | ${{ vars.AZURE_LOCATION_PRIMARY }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Secondary Region | ${{ vars.AZURE_LOCATION_SECONDARY }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Get values directly from Azure (more reliable than azd env)
          PRIMARY_RG="rg-bing-grounding-mcp-${{ needs.validate.outputs.environment_name }}"
          SECONDARY_RG="rg-bing-grounding-mcp-${{ needs.validate.outputs.environment_name }}-secondary"
          
          # Primary region resources
          echo "### ðŸ“‹ Primary Region Resources" >> $GITHUB_STEP_SUMMARY
          PRIMARY_WEBAPP=$(az webapp list --resource-group $PRIMARY_RG --query "[0].name" -o tsv 2>/dev/null || echo "")
          PRIMARY_FOUNDRY=$(az cognitiveservices account list --resource-group $PRIMARY_RG --query "[?kind=='AIServices'].name | [0]" -o tsv 2>/dev/null || echo "")
          PRIMARY_ENDPOINT=$(az cognitiveservices account list --resource-group $PRIMARY_RG --query "[?kind=='AIServices'].properties.endpoint | [0]" -o tsv 2>/dev/null || echo "")
          PRIMARY_BING=$(az resource list --resource-group $PRIMARY_RG --resource-type "Microsoft.Bing/accounts" --query "[0].name" -o tsv 2>/dev/null || echo "")
          PRIMARY_BING_ID=$(az resource list --resource-group $PRIMARY_RG --resource-type "Microsoft.Bing/accounts" --query "[0].id" -o tsv 2>/dev/null || echo "")
          
          echo "| Resource | Name |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| Resource Group | $PRIMARY_RG |" >> $GITHUB_STEP_SUMMARY
          echo "| Web App | $PRIMARY_WEBAPP |" >> $GITHUB_STEP_SUMMARY
          echo "| AI Foundry | $PRIMARY_FOUNDRY |" >> $GITHUB_STEP_SUMMARY
          echo "| Bing Grounding | $PRIMARY_BING |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Secondary region resources (if exists)
          SECONDARY_WEBAPP=$(az webapp list --resource-group $SECONDARY_RG --query "[0].name" -o tsv 2>/dev/null || echo "")
          SECONDARY_FOUNDRY=$(az cognitiveservices account list --resource-group $SECONDARY_RG --query "[?kind=='AIServices'].name | [0]" -o tsv 2>/dev/null || echo "")
          SECONDARY_ENDPOINT=$(az cognitiveservices account list --resource-group $SECONDARY_RG --query "[?kind=='AIServices'].properties.endpoint | [0]" -o tsv 2>/dev/null || echo "")
          SECONDARY_BING=$(az resource list --resource-group $SECONDARY_RG --resource-type "Microsoft.Bing/accounts" --query "[0].name" -o tsv 2>/dev/null || echo "")
          SECONDARY_BING_ID=$(az resource list --resource-group $SECONDARY_RG --resource-type "Microsoft.Bing/accounts" --query "[0].id" -o tsv 2>/dev/null || echo "")
          
          if [ -n "$SECONDARY_WEBAPP" ]; then
            echo "### ðŸ“‹ Secondary Region Resources" >> $GITHUB_STEP_SUMMARY
            echo "| Resource | Name |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|------|" >> $GITHUB_STEP_SUMMARY
            echo "| Resource Group | $SECONDARY_RG |" >> $GITHUB_STEP_SUMMARY
            echo "| Web App | $SECONDARY_WEBAPP |" >> $GITHUB_STEP_SUMMARY
            echo "| AI Foundry | $SECONDARY_FOUNDRY |" >> $GITHUB_STEP_SUMMARY
            echo "| Bing Grounding | $SECONDARY_BING |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # GitHub Environment Variables - Clear format for copy/paste
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "## âš ï¸ Required GitHub Environment Variables" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Copy these values to **GitHub Settings â†’ Environments**:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### For \`production-primary\` environment:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Variable | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| \`AZURE_WEBAPP_NAME_PRIMARY\` | \`$PRIMARY_WEBAPP\` |" >> $GITHUB_STEP_SUMMARY
          echo "| \`AZURE_AI_PROJECT_ENDPOINT_PRIMARY\` | \`$PRIMARY_ENDPOINT\` |" >> $GITHUB_STEP_SUMMARY
          echo "| \`BING_GROUNDING_RESOURCE_ID_PRIMARY\` | \`$PRIMARY_BING_ID\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -n "$SECONDARY_WEBAPP" ]; then
            echo "### For \`production-secondary\` environment:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Variable | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| \`AZURE_WEBAPP_NAME_SECONDARY\` | \`$SECONDARY_WEBAPP\` |" >> $GITHUB_STEP_SUMMARY
            echo "| \`AZURE_AI_PROJECT_ENDPOINT_SECONDARY\` | \`$SECONDARY_ENDPOINT\` |" >> $GITHUB_STEP_SUMMARY
            echo "| \`BING_GROUNDING_RESOURCE_ID_SECONDARY\` | \`$SECONDARY_BING_ID\` |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Infrastructure provisioned successfully!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next Steps:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Copy the values above to GitHub Settings â†’ Environments" >> $GITHUB_STEP_SUMMARY
          echo "2. Run the **Deploy to Azure App Service** workflow" >> $GITHUB_STEP_SUMMARY

  deploy:
    name: Deploy Application
    needs: [validate, provision]
    runs-on: ubuntu-latest
    if: |
      always() && 
      (github.event.inputs.action == 'deploy' || github.event.inputs.action == 'up') &&
      (needs.provision.result == 'success' || needs.provision.result == 'skipped')
    environment:
      name: ${{ needs.validate.outputs.environment_name }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Python dependencies
        run: pip install -r requirements.txt

      - name: Install azd
        run: curl -fsSL https://aka.ms/install-azd.sh | bash

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Configure azd environment
        run: |
          azd config set auth.useAzCliAuth true
          azd env select ${{ needs.validate.outputs.environment_name }} || \
            azd env new ${{ needs.validate.outputs.environment_name }} --no-prompt
          
          azd env set AZURE_LOCATION "${{ vars.AZURE_LOCATION_PRIMARY }}"
          azd env set AZURE_SUBSCRIPTION_ID "${{ secrets.AZURE_SUBSCRIPTION_ID }}"

      - name: Deploy application
        run: |
          azd deploy --no-prompt
        env:
          AZURE_ENV_NAME: ${{ needs.validate.outputs.environment_name }}
          AZURE_LOCATION: ${{ vars.AZURE_LOCATION_PRIMARY }}
          AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Run post-deploy hooks
        if: github.event.inputs.skip_hooks != 'true'
        run: |
          echo "Running post-deploy scripts..."
          python scripts/postdeploy_configure_appservice.py || true
        env:
          AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          AZURE_ENV_NAME: ${{ needs.validate.outputs.environment_name }}

  teardown:
    name: Tear Down Infrastructure
    needs: validate
    runs-on: ubuntu-latest
    if: github.event.inputs.action == 'down'
    environment:
      name: ${{ needs.validate.outputs.environment_name }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install azd
        run: curl -fsSL https://aka.ms/install-azd.sh | bash

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Configure azd environment
        run: |
          azd config set auth.useAzCliAuth true
          azd env select ${{ needs.validate.outputs.environment_name }}

      - name: Confirm teardown
        run: |
          echo "âš ï¸ WARNING: This will delete all resources in environment: ${{ needs.validate.outputs.environment_name }}"
          echo ""
          echo "Resources to be deleted:"
          azd env get-values | grep -E "^AZURE_" || true

      - name: Tear down infrastructure
        run: |
          azd down --force --purge --no-prompt
        env:
          AZURE_ENV_NAME: ${{ needs.validate.outputs.environment_name }}
          AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Summary
        run: |
          echo "## Teardown Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Environment **${{ needs.validate.outputs.environment_name }}** has been deleted." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ Note: Some resources may be soft-deleted. Use Azure Portal to purge if needed." >> $GITHUB_STEP_SUMMARY

  summary:
    name: Workflow Summary
    needs: [validate, provision, deploy, teardown, what-if]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Generate summary
        run: |
          echo "## Infrastructure Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| What-If | ${{ needs.what-if.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Provision | ${{ needs.provision.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy | ${{ needs.deploy.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Teardown | ${{ needs.teardown.result }} |" >> $GITHUB_STEP_SUMMARY
